@page "/graphs"
@using WebsiteFirstDraft.Data.Models
@rendermode InteractiveServer

<br />
<div class="container-fluid">
    <div class="card shadow-sm">
        <div class="card-body">

            @* QUESTION 1 *@
            <div class="mb-4">
                <label class="form-label">
                    <strong>
                        What category of graph are you looking for?
                    </strong>
                </label>
                <select class="form-select" @bind="GraphCategory">
                    <option disabled value="">Select an option</option>
                    <option>BodyweightProgress</option>
                    <option>CalorieTracking</option>
                    <option>Macros</option>
                    <option>Hypertrophy</option>
                    <option>Exercise</option>
                    <option>Consistency</option>
                </select>
            </div>

        @* QUESTION 2 *@
        <div class="mb-4">
            <label class="form-label">
                <strong>
                    Select your graph
                </strong>
            </label>
            <select class="form-select">
                <option disabled value="">Select an option</option>

                    @if (GraphCategory.HasValue)
                    {
                        switch ((int) GraphCategory)
                        {
                            case 0:
                                <option>Bodyweight over time</option>
                                <option>Weight Change per week</option>
                                break;
                            case 1:
                                <option>Daily Calorie Intake vs Target</option>
                                <option>Daily calorie surplus/deficit</option>
                                break;
                            case 2:
                                <option>Average Macro Distribution</option>
                                <option>Daily macro intake</option>
                                break;
                            case 3:
                                <option>#To be Completed</option>
                                break;
                            case 4:
                                <option>Calories burnt through Exercise</option>
                                <option>Exercise type frequency</option>
                                break;
                            case 5:
                                <option>Logging streak over time</option>
                                <option>Activity consistency</option>
                                break;
                            default:
                                break;
                        }
                    }

            </select>
        </div>

        </div>
    </div>
</div>


<div class="container-fluid overflow-x-auto">
    <LineChart @ref="lineChart" Width="800" Height="400" />
</div>

@code 
{
        // Reference to the LineChart component instance (initialised later)
        private LineChart lineChart = default!; 

        // Configuration options for the line chart
        private LineChartOptions lineChartOptions = default!; 

        // Data model (labels + datasets) for the chart
        private ChartData chartData = default!; 

        // Counter for how many datasets have been created
        private int datasetsCount;

        // Counter for how many labels (data points) have been created
        private int labelsCount;

        // Random number generator used to create sample data
        private Random random = new();

        // Lifecycle method: initialize component state before rendering
        protected override void OnInitialized()
        {
            // Create initial labels and datasets for the chart
            chartData = new ChartData { Labels = GetDefaultDataLabels(6), Datasets = GetDefaultDataSets(1) };

            // Set default chart options (horizontal index axis, interaction mode, responsive)
            // and configure Y axis to allow negative values in the range -1 .. 1.
            lineChartOptions = new()
            {
                IndexAxis = "x",
                Interaction = new Interaction { Mode = InteractionMode.Index, Intersect = false },
                Responsive = true,
                // Scales configuration to allow negative values on Y axis.
                // Types used here are consistent with the chart types available in the project.
                Scales = new Scales
                {
                    Y = new()
                    {
                        BeginAtZero = false,
                        Min = -1,
                        Max = 1
                    }
                }
            };
        }

        // Lifecycle method: runs after component has rendered
        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            // If this is the first render, initialize the JS/chart with current data and options
            if (firstRender)
            {
                await lineChart.InitializeAsync(chartData, lineChartOptions);
            }
            // Call base implementation
            await base.OnAfterRenderAsync(firstRender);
        }


        #region Data Preparation

        // Create a list of default datasets
        private List<IChartDataset> GetDefaultDataSets(int numberOfDatasets)
        {
            var datasets = new List<IChartDataset>();

            // Generate the requested number of random datasets
            for (var index = 0; index < numberOfDatasets; index++)
            {
                datasets.Add(GetRandomLineChartDataset());
            }

            return datasets;
        }

        // Build a single LineChartDataset with random data and styling
        private LineChartDataset GetRandomLineChartDataset()
        {
            // Select a color from a categorical palette based on datasetsCount
            var c = ColorUtility.CategoricalTwelveColors[datasetsCount].ToColor();

            // Increment the datasets counter (used for labeling and next color)
            datasetsCount += 1;

            // Return a configured dataset with label, random data and appearance settings
            return new LineChartDataset
            {
                Label = $"Weight change (kg)",
                Data = GetRandomData(),
                BackgroundColor = c.ToRgbaString(),
                BorderColor = c.ToRgbString(),
                PointRadius = new List<double> { 5 },
                PointHoverRadius = new List<double> { 8 },
            };
        }

        // Generate a list of random numeric data points matching current label count
        // Now returns values in the range -1 .. 1.
        private List<double?> GetRandomData()
        {
            var data = new List<double?>();
            for (var index = 0; index < labelsCount; index++)
            {
                // random.NextDouble() --> [0.0, 1.0)
                // map to [-1.0, 1.0): (value * 2) - 1
                data.Add((random.NextDouble() * 2.0) - 1.0);
            }

            return data;
        }

        // Create a list of default labels using GetNextDataLabel
        private List<string> GetDefaultDataLabels(int numberOfLabels)
        {
            var labels = new List<string>();
            for (var index = 0; index < numberOfLabels; index++)
            {
                labels.Add(GetNextDataLabel());
            }

            return labels;
        }

        // Produce the next sequential label (e.g., "Day 1", "Day 2") and increment label counter
        private string GetNextDataLabel()
        {
            labelsCount += 1;
            return $"Week {labelsCount}";
        }


    #endregion Data Preparation

    private GraphCategories? GraphCategory;


    private enum GraphCategories
    {
        BodyweightProgress,
        CalorieTracking,
        Macros,
        Hypertrophy,
        Exercise,
        Consistency
    }


}